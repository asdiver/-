# 海螺聊天室用户举报系统

### 背景

作为一个聊天室，交流圈，对用户发言的管理必不可少，暂不是用户的发言内容进行直接的筛选，而采用简单的举报方式

### 相关资料

无

### 方案内容

#### 功能:

对被举报过多的用户账号进行短时间封禁

#### 涉及的部分及其作用

##### 初始方案

- 数据库：
  
  - **用户表**：含有用户被冻结的时间戳，当前时间小于此时间戳则视为冻结，默认为用户注册时间戳
    
  - **举报表**：包含举报人和被举报人 举报时间
    
- node后端：
  
  - **身份校验中间件**：解析token，获取token内容，**用户表解冻日期**放在token中 且每次访问 （注册 登录 http轮询）以外的接口 都会对用户是否在冻结时间内进行分析，判定为冻结时间将拒绝请求
    
  - **登录接口**：**身份校验中间件**不对**登录接口**进行检查 **登录接口**本身需要对是否冻结状态进行检查，且写入token
    
  - **举报接口**：在举报记录成功加入**举报表**后，进行一次是否冻结目标用户的判断
    
    1拿到**用户表**的冻结时间戳
    
    2 查询**举报表**对目标用户的记录 ！！！筛选条件为举报时间在冻结时间戳之后
    
    3 进行判断 假设机制为 （两天内被四个账号举报 则举报成功） 则当判断返回的条数 不少于四个 且头记录和尾记录时间相差不超过两天 举报就成立 更新**用户表**的冻结时间戳
    
  - **http轮询接口**：包含但不限于：查询**用户表** 判断用户是否冻结状态，是则设置更新cookie中的token
    

##### 分析

即使冻结时间放token，但是 **身份校验中间件** 只会对token校验，无法保证冻结时间戳的有效性，用户使用旧 http轮询依旧可以绕过账号冻结。

但是http轮询对数据库的冻结状态校验，更新token 使得被冻结的用户篡改token后也会被http周期性进行更新。

http轮询对冻结状态的审查又使得**身份校验中间件**的审查变得多余，只依赖于轮询也可以实现，http轮询冻结审查的必要性又建立于用户手动更改token

同时后续如果改为websocket替代http轮询将会失效 ，或许可以保留http轮询 只传递是否冻结 其他消息改为websocket

##### 方案优化

- 优化的原因
  
  其实最初的想法是在**身份校验中间件**中直接对数据库进行查询 但是这意味着每次的http请求查询都会附带一次对数据库的查询操作 而用户冻结的状态并不是频繁改变的，这意味着资源的无意义消耗。
  
  上面的方案中时候的是把冻结状态放在token **身份校验中间件** 负责查询 http轮询负责防止用户篡改token 这只是把频繁的数据库查询换到了 http轮询中
  
- 优化点
  
  在举报系统中去掉**http轮询**,让**身份校验中间件**周期性的查询数据库，怎么周期性呢？在token中再加入一个字段为上一次通过数据库查询的时间戳 每次拿到token后，当上一次数据库查询超过了设置的某个时间点 就要求重新查询，没超过时间阀 就直接拿token中的过期状态
  

### 方案补充

无

### 其他事项

无
